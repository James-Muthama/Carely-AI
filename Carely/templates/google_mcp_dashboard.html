{% extends "base.html" %}

{% block content %}

    <header>
        <a href="{{ url_for('homepage') }}"><h1>Carely</h1></a>
    </header>

    <div id="left_column">
        <a href="{{ url_for('profile') }}" id="profile_link">
            <div id="profile">
                <div id="profile_info">
                    <div id="profile_photo_container">
                        <img src="{{ url_for('profile_image') }}" alt="Profile Photo" id="profile_photo">
                    </div>
                    <div id="company_name">{{ session['user'] }}</div>
                </div>
            </div>
        </a>
        <a href="{{ url_for('customer_agent') }}" id="upload_link">Customer Support <br>Carely Agent</a>
        <a href="{{ url_for('integration') }}" id="mcp_link">Integrations Hub</a>
        <a href="{{ url_for('chat_interface') }}" id="dashboard_link">Business Carely <br>Assistant</a>
        <div id="logout_image_container">
            <div id="logout_image_cont">
                <img src="{{ url_for('static', filename='images/logout_img.png') }}" alt="Logout Image" id="logout_image">
            </div>
            <a href="{{ url_for('logout') }}" id="logout_link">Logout</a>
        </div>
    </div>

    <div id="content">
        <div id="welcome_msg">
            <p id="welcome">Google Workspace Dashboard</p>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-container">
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">
                            {% if category == 'error' %}
                                <i class="fas fa-exclamation-triangle"></i>
                            {% elif category == 'success' %}
                                <i class="fas fa-check-circle"></i>
                            {% elif category == 'warning' %}
                                <i class="fas fa-exclamation-circle"></i>
                            {% endif %}
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- System Status Row -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px;">

            <!-- Authentication Status -->
            <div class="status-card" id="auth-status-card">
                <div class="status-header">
                    <h3>
                        <img src="{{ url_for('static', filename='images/Google_logo.webp') }}" alt="Google Logo" style="height: 24px; width: auto; margin-right: 10px;">
                        Google Authentication</h3>
                    <span class="status-indicator" id="auth-indicator"></span>
                </div>
                <div class="status-content">
                    <div class="status-value" id="auth-status">Checking...</div>
                    <div class="status-detail" id="auth-details">Google Authentication</div>
                </div>
            </div>

            <!-- Tools Status -->
            <div class="status-card" id="tools-status-card">
                <div class="status-header">
                    <h3><i class="fas fa-tools"></i> Available Tools</h3>
                    <span class="status-indicator" id="tools-indicator"></span>
                </div>
                <div class="status-content">
                    <div class="status-value" id="tools-status">Checking...</div>
                    <div class="status-detail" id="tools-count">Google Workspace Tools</div>
                </div>
            </div>
        </div>


        <!-- Google Authentication Section -->
        <div class="content-box" style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0; color: #1e293b; display: flex; align-items: center;">
                    <img src="{{ url_for('static', filename='images/Google_logo.webp') }}" alt="Google Logo" style="height: 24px; width: auto; margin-right: 10px;">
                    Google Authentication
                </h2>
                <button class="btn btn-outline-primary btn-sm" onclick="checkAuthStatus()" style="margin-left: 20px;">
                    <i class="fas fa-sync-alt"></i> Check Status
                </button>
            </div>

            <div id="auth-section">
                <!-- Not Authenticated State -->
                <div id="not-authenticated" class="auth-state" style="display: none;">
                    <div class="auth-flow-steps">
                        <h4>Authentication Process:</h4>
                        <ol>
                            <li>Click "Start Google Authentication" below</li>
                            <li>Complete Google Authentication in the opened window</li>
                            <li>Return here and the status will update automatically</li>
                            <li>Available tools will be displayed after Google Authentication</li>
                        </ol>
                    </div>
                    <div class="auth-actions">
                        <button class="btn btn-primary" onclick="startGoogleAuth()">
                            <i class="fab fa-google"></i> Start Google Authentication
                        </button>
                    </div>
                </div>

                <!-- Authenticated State -->
                <div id="authenticated" class="auth-state" style="display: none;">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        Successfully authenticated with Google!
                        <div class="auth-timestamp" id="auth-timestamp"></div>
                    </div>
                    <div class="auth-actions">
                        <button class="btn btn-outline-success" onclick="testAuthentication()">
                            <i class="fas fa-flask"></i> Test Authentication
                        </button>
                        <button class="btn btn-outline-warning" onclick="revokeAuthentication()">
                            <i class="fas fa-sign-out-alt"></i> Clear Authentication
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="auth-loading" class="auth-state" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-spinner fa-spin"></i>
                        Checking authentication status...
                    </div>
                </div>

                <!-- Error State -->
                <div id="auth-error" class="auth-state" style="display: none;">
                    <div class="alert alert-danger" id="auth-error-message"></div>
                    <div class="auth-actions">
                        <button class="btn btn-outline-primary" onclick="startGoogleAuth()">
                            <i class="fab fa-google"></i> Try Authentication Again
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Google Services Status -->
        <div class="content-box" style="margin-bottom: 20px;">
            <h2 style="color: #1e293b; display: flex; align-items: center;">
                <i class="fas fa-cloud" style="margin-right: 10px; color: #4682B4;"></i>
                Google Services Access
            </h2>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="service-card" data-service="gmail">
                    <div class="service-header">
                        <span class="service-indicator"></span>
                        <h4>Gmail</h4>
                    </div>
                    <p class="service-description">Email management and search</p>
                    <div class="service-status">Not authenticated</div>
                </div>

                <div class="service-card" data-service="drive">
                    <div class="service-header">
                        <span class="service-indicator"></span>
                        <h4>Google Drive</h4>
                    </div>
                    <p class="service-description">File storage and management</p>
                    <div class="service-status">Not authenticated</div>
                </div>

                <div class="service-card" data-service="calendar">
                    <div class="service-header">
                        <span class="service-indicator"></span>
                        <h4>Google Calendar</h4>
                    </div>
                    <p class="service-description">Calendar and event management</p>
                    <div class="service-status">Not authenticated</div>
                </div>

                <div class="service-card" data-service="docs">
                    <div class="service-header">
                        <span class="service-indicator"></span>
                        <h4>Google Docs</h4>
                    </div>
                    <p class="service-description">Document creation and editing</p>
                    <div class="service-status">Not authenticated</div>
                </div>

                <div class="service-card" data-service="sheets">
                    <div class="service-header">
                        <span class="service-indicator"></span>
                        <h4>Google Sheets</h4>
                    </div>
                    <p class="service-description">Spreadsheet management</p>
                    <div class="service-status">Not authenticated</div>
                </div>

                <div class="service-card" data-service="forms">
                    <div class="service-header">
                        <span class="service-indicator"></span>
                        <h4>Google Forms</h4>
                    </div>
                    <p class="service-description">Form creation and responses</p>
                    <div class="service-status">Not authenticated</div>
                </div>
            </div>
        </div>

        <!-- Google Workspace Tools Section -->
        <div class="content-box" id="tools-section" style="display: none; margin-bottom: 20px;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0; color: #1e293b; display: flex; align-items: center;">
                    <i class="fas fa-tools" style="margin-right: 10px; color: #4682B4;"></i>
                    Google Workspace Tools
                </h2>
                <button class="btn btn-outline-primary btn-sm" onclick="loadTools()" id="load-tools-btn" style="margin-left: 20px;">
                    <i class="fas fa-sync-alt"></i> Load Tools
                </button>
            </div>

            <div id="tools-container">
                <div id="tools-loading" class="loading-state" style="display: none;">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>Loading Google Workspace tools...</p>
                </div>

                <div id="tools-list"></div>

                <div id="no-tools" class="empty-state" style="display: none;">
                    <i class="fas fa-tools fa-3x"></i>
                    <h4>No tools loaded</h4>
                    <p>Authenticate with Google first, then load tools.</p>
                </div>
            </div>
        </div>

        <!-- Debug Information -->
        <div class="content-box" id="debug-card" style="display: none;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0; color: #1e293b; display: flex; align-items: center;">
                    <i class="fas fa-bug" style="margin-right: 10px; color: #dc2626;"></i>
                    Debug Information
                </h2>
                <button class="btn btn-outline-secondary btn-sm" onclick="hideDebugInfo()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
            <div id="debug-info">
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>Loading debug information...</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Enhanced styles for the integrated dashboard */
        .content-box {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .content-box h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 20px;
        }

        /* Connection diagram styles */
        .connection-diagram {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            margin: 15px 0;
            flex-wrap: wrap;
            gap: 20px;
        }

        .connection-node {
            text-align: center;
            flex: 1;
            min-width: 120px;
        }

        .connection-icon {
            margin-bottom: 8px;
        }

        .connection-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
        }

        .connection-arrow {
            font-size: 24px;
            color: #6c757d;
            margin: 0 10px;
        }

        @media (max-width: 768px) {
            .connection-arrow {
                transform: rotate(90deg);
            }
        }

        /* Status card styles */
        .status-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #6c757d;
            transition: all 0.3s ease;
        }

        .status-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .status-card.healthy { border-left-color: #28a745; }
        .status-card.warning { border-left-color: #ffc107; }
        .status-card.error { border-left-color: #dc3545; }
        .status-card.unknown { border-left-color: #6c757d; }

        .status-header {
        display: flex;
        justify-content: space-between; /* Fix typo and ensure proper spacing */
        align-items: center;
        gap: 16px; /* Increase spacing between text/icon and dot */
        margin-bottom: 12px;
        }

        .status-header h3 {
            margin: 0;
            font-size: 16px;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #6c757d;
            display: inline-block;
        }

        .status-indicator.healthy { background-color: #28a745; }
        .status-indicator.warning { background-color: #ffc107; }
        .status-indicator.error { background-color: #dc3545; }

        .status-value {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .status-detail {
            font-size: 12px;
            color: #64748b;
        }

        /* Authentication section styles */
        .auth-state {
            transition: all 0.3s ease;
        }

        .auth-flow-steps {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #4682B4;
        }

        .auth-flow-steps h4 {
            margin: 0 0 10px 0;
            color: #1e293b;
        }

        .auth-flow-steps ol {
            margin: 0;
            padding-left: 20px;
        }

        .auth-flow-steps li {
            margin-bottom: 8px;
            color: #64748b;
        }

        .auth-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .auth-timestamp {
            margin-top: 8px;
            font-size: 12px;
            opacity: 0.8;
        }

        /* Service card styles */
        .service-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.2s ease;
        }

        .service-card:hover {
            box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.1);
            border-color: #cbd5e1;
        }

        .service-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .service-header h4 {
            margin: 0;
            color: #1e293b;
            font-size: 14px;
        }

        .service-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
            display: inline-block;
        }

        .service-indicator.available { background: #10b981; }

        .service-description {
            margin: 0 0 8px 0;
            font-size: 12px;
            color: #64748b;
        }

        .service-status {
            font-size: 11px;
            color: #9ca3af;
            font-weight: 500;
        }

        .service-status.available {
            color: #059669;
        }

        /* Tools section styles */
        .tool-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            transition: all 0.2s ease;
        }

        .tool-item:hover {
            border-color: #4682B4;
            box-shadow: 0 2px 8px rgba(70, 130, 180, 0.1);
        }

        .tool-item h4 {
            margin: 0 0 8px 0;
            color: #1e293b;
            font-size: 14px;
        }

        .tool-item p {
            margin: 0;
            color: #64748b;
            font-size: 12px;
        }

        .tool-badge {
            display: inline-block;
            background: #e0f2fe;
            color: #0277bd;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            margin-top: 8px;
        }

        /* Alert styles */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 1px solid #16a34a;
            color: #15803d;
        }

        .alert-info {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 1px solid #2563eb;
            color: #1d4ed8;
        }

        .alert-danger {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 1px solid #dc2626;
            color: #b91c1c;
        }

        /* Button styles */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4682B4 0%, #1e293b 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #3a6b94 0%, #15202b 100%);
            transform: translateY(-1px);
        }

        .btn-outline-primary {
            background: transparent;
            color: #4682B4;
            border: 1px solid #4682B4;
        }

        .btn-outline-primary:hover {
            background: #4682B4;
            color: white;
        }

        .btn-outline-secondary {
            background: transparent;
            color: #6c757d;
            border: 1px solid #6c757d;
        }

        .btn-outline-secondary:hover {
            background: #6c757d;
            color: white;
        }

        .btn-outline-success {
            background: transparent;
            color: #28a745;
            border: 1px solid #28a745;
        }

        .btn-outline-success:hover {
            background: #28a745;
            color: white;
        }

        .btn-outline-warning {
            background: transparent;
            color: #ffc107;
            border: 1px solid #ffc107;
        }

        .btn-outline-warning:hover {
            background: #ffc107;
            color: #212529;
        }

        .btn-light {
            background: rgba(255, 255, 255, 0.9);
            color: #495057;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .btn-outline-light {
            background: transparent;
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Loading and empty states */
        .loading-state, .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .loading-state i, .empty-state i {
            margin-bottom: 15px;
            color: #9ca3af;
        }

        .loading-state p, .empty-state p {
            margin: 0;
        }

        .empty-state h4 {
            margin: 10px 0;
            color: #6c757d;
        }

        /* Flash messages */
        .flash-container {
            margin-bottom: 20px;
        }

        .flash-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .flash-success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 1px solid #16a34a;
            color: #15803d;
        }

        .flash-error {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 1px solid #dc2626;
            color: #b91c1c;
        }

        .flash-warning {
            background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
            border: 1px solid #ca8a04;
            color: #a16207;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .auth-actions {
                flex-direction: column;
            }

            .auth-actions .btn {
                width: 100%;
                justify-content: center;
            }

            #content {
                padding: 10px;
            }

            .content-box {
                padding: 15px;
            }
        }
    </style>

    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script>
        // Global state
        let authStatus = {
            oauth_configured: false,
            google_authenticated: false,
            server_healthy: false,
            tools_count: 0
        };

        // Initialize dashboard on page load
        document.addEventListener('DOMContentLoaded', function() {
            refreshAll();

            // Listen for auth completion messages from popups
            window.addEventListener('message', function(event) {
                if (event.origin !== window.location.origin) return;

                if (event.data.type === 'auth_success') {
                    console.log('Auth success message received:', event.data);
                    showNotification('success', 'Google authentication successful!');
                    setTimeout(() => {
                        checkAuthStatus();
                    }, 2000);
                } else if (event.data.type === 'auth_error') {
                    console.log('Auth error message received:', event.data);
                    showNotification('error', event.data.message || 'Authentication failed');
                }
            });
        });

        // Refresh all dashboard data
        async function refreshAll() {
            const refreshIcon = document.getElementById('refreshIcon');
            if (refreshIcon) {
                refreshIcon.classList.add('fa-spin');
            }

            try {
                await Promise.all([
                    checkServerHealth(),
                    checkAuthStatus()
                ]);
            } finally {
                if (refreshIcon) {
                    refreshIcon.classList.remove('fa-spin');
                }
            }
        }

        // Check MCP server health
        async function checkServerHealth() {
            try {
                const response = await fetch('/mcp/health');
                const data = await response.json();

                authStatus.server_healthy = data.status === 'healthy';
                authStatus.oauth_configured = data.oauth_configured;

                updateServerStatus(data);

            } catch (error) {
                console.error('Health check failed:', error);
                authStatus.server_healthy = false;
                updateServerStatus({
                    status: 'error',
                    error: 'Connection failed'
                });
            }
        }

        // Update server status display
        function updateServerStatus(data) {
            const statusCard = document.getElementById('server-status-card');
            const indicator = document.getElementById('server-indicator');
            const statusValue = document.getElementById('server-status');
            const statusDetail = document.getElementById('server-url');

            if (data.status === 'healthy') {
                statusCard.className = 'status-card healthy';
                indicator.className = 'status-indicator healthy';
                statusValue.textContent = 'Connected';
                statusValue.style.color = '#059669';
            } else if (data.status === 'degraded') {
                statusCard.className = 'status-card warning';
                indicator.className = 'status-indicator warning';
                statusValue.textContent = 'Degraded';
                statusValue.style.color = '#d97706';
            } else {
                statusCard.className = 'status-card error';
                indicator.className = 'status-indicator error';
                statusValue.textContent = data.error || 'Disconnected';
                statusValue.style.color = '#dc2626';
            }

            statusDetail.textContent = `${data.server_url || 'http://localhost:8000'}${data.server_version ? ` (${data.server_version})` : ''}`;
        }

        // Check authentication status
        async function checkAuthStatus() {
            showAuthState('auth-loading');

            try {
                const response = await fetch('/mcp/auth/status');
                const data = await response.json();

                authStatus = { ...authStatus, ...data };

                updateAuthStatus(data);
                updateServicesStatus(data.google_authenticated);
                updateToolsStatus(data.tools_count || 0);

                if (data.google_authenticated) {
                    document.getElementById('tools-section').style.display = 'block';
                    loadTools();
                }

            } catch (error) {
                console.error('Failed to check auth status:', error);
                showAuthError('Failed to check authentication status');
            }
        }

        // Update authentication status display
        function updateAuthStatus(data) {
            const authCard = document.getElementById('auth-status-card');
            const authIndicator = document.getElementById('auth-indicator');
            const authStatusValue = document.getElementById('auth-status');
            const authDetails = document.getElementById('auth-details');

            if (data.google_authenticated) {
                authCard.className = 'status-card healthy';
                authIndicator.className = 'status-indicator healthy';
                authStatusValue.textContent = 'Authenticated';
                authStatusValue.style.color = '#059669';
                authDetails.textContent = 'Google account connected';

                showAuthState('authenticated');

                // Update timestamp if available
                const timestampEl = document.getElementById('auth-timestamp');
                if (timestampEl && data.session_authenticated) {
                    timestampEl.textContent = 'Session active';
                }

            } else if (data.oauth_configured) {
                authCard.className = 'status-card warning';
                authIndicator.className = 'status-indicator warning';
                authStatusValue.textContent = 'Not Authenticated';
                authStatusValue.style.color = '#d97706';
                authDetails.textContent = 'Google Authentication required';

                showAuthState('not-authenticated');

            } else {
                authCard.className = 'status-card error';
                authIndicator.className = 'status-indicator error';
                authStatusValue.textContent = 'Not Configured';
                authStatusValue.style.color = '#dc2626';
                authDetails.textContent = 'OAuth credentials missing';

                showAuthError('OAuth credentials not configured. Please set GOOGLE_OAUTH_CLIENT_ID and GOOGLE_OAUTH_CLIENT_SECRET environment variables.');
            }
        }

        // Show specific authentication state
        function showAuthState(stateId) {
            const states = ['not-authenticated', 'authenticated', 'auth-loading', 'auth-error'];
            states.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = id === stateId ? 'block' : 'none';
                }
            });
        }

        // Show authentication error
        function showAuthError(message) {
            const errorMessageEl = document.getElementById('auth-error-message');
            if (errorMessageEl) {
                errorMessageEl.textContent = message;
            }
            showAuthState('auth-error');
        }

        // Update services status
        function updateServicesStatus(authenticated) {
            const services = ['gmail', 'drive', 'calendar', 'docs', 'sheets', 'forms'];

            services.forEach(service => {
                const card = document.querySelector(`[data-service="${service}"]`);
                if (card) {
                    const indicator = card.querySelector('.service-indicator');
                    const status = card.querySelector('.service-status');

                    if (authenticated) {
                        indicator.className = 'service-indicator available';
                        status.textContent = 'Available';
                        status.className = 'service-status available';
                    } else {
                        indicator.className = 'service-indicator';
                        status.textContent = 'Not authenticated';
                        status.className = 'service-status';
                    }
                }
            });
        }

        // Update tools status
        function updateToolsStatus(toolsCount) {
            const toolsCard = document.getElementById('tools-status-card');
            const toolsIndicator = document.getElementById('tools-indicator');
            const toolsStatusValue = document.getElementById('tools-status');
            const toolsCountEl = document.getElementById('tools-count');

            authStatus.tools_count = toolsCount;

            if (toolsCount > 0) {
                toolsCard.className = 'status-card healthy';
                toolsIndicator.className = 'status-indicator healthy';
                toolsStatusValue.textContent = `${toolsCount} Available`;
                toolsStatusValue.style.color = '#059669';
                toolsCountEl.textContent = 'Google Workspace Tools';
            } else if (authStatus.google_authenticated) {
                toolsCard.className = 'status-card warning';
                toolsIndicator.className = 'status-indicator warning';
                toolsStatusValue.textContent = 'Loading...';
                toolsStatusValue.style.color = '#d97706';
                toolsCountEl.textContent = 'Checking availability';
            } else {
                toolsCard.className = 'status-card unknown';
                toolsIndicator.className = 'status-indicator';
                toolsStatusValue.textContent = 'Not Available';
                toolsStatusValue.style.color = '#6c757d';
                toolsCountEl.textContent = 'Authentication required';
            }
        }

        // Start Google authentication
        async function startGoogleAuth() {
            try {
                showNotification('info', 'Initiating Google authentication...');

                const response = await fetch('/mcp/auth/google', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.auth_url) {
                    // Open authentication URL in popup window
                    const authWindow = window.open(
                        data.auth_url,
                        'GoogleAuth',
                        'width=600,height=700,scrollbars=yes,resizable=yes'
                    );

                    // Monitor popup window
                    const checkClosed = setInterval(() => {
                        if (authWindow.closed) {
                            clearInterval(checkClosed);
                            // Check auth status after popup closes
                            setTimeout(() => {
                                checkAuthStatus();
                            }, 1000);
                        }
                    }, 1000);

                    showNotification('info', 'Google authentication window opened. Complete the process in the popup.');

                } else {
                    showNotification('error', data.error || 'Failed to initiate authentication');
                }

            } catch (error) {
                console.error('Auth initiation failed:', error);
                showNotification('error', 'Failed to initiate Google authentication');
            }
        }

        // Test authentication
        async function testAuthentication() {
            try {
                showNotification('info', 'Testing Google connection...');

                const response = await fetch('/mcp/auth/test');
                const data = await response.json();

                if (data.success) {
                    showNotification('success', `Google connection test successful! Tools available: ${data.tools_available || 0}`);
                    updateServicesStatus(true);
                    if (data.tools_available > 0) {
                        loadTools();
                    }
                } else {
                    showNotification('error', data.error || 'Google connection test failed');
                }

            } catch (error) {
                console.error('Auth test failed:', error);
                showNotification('error', 'Failed to test Google connection');
            }
        }

        // Revoke authentication
        async function revokeAuthentication() {
            if (!confirm('Are you sure you want to disconnect your Google account? This will remove access to all Google services.')) {
                return;
            }

            try {
                const response = await fetch('/mcp/auth/revoke', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    showNotification('success', 'Google account disconnected successfully');
                    authStatus.google_authenticated = false;
                    updateAuthStatus({ google_authenticated: false, oauth_configured: authStatus.oauth_configured });
                    updateServicesStatus(false);
                    updateToolsStatus(0);
                    document.getElementById('tools-section').style.display = 'none';
                } else {
                    showNotification('error', data.error || 'Failed to disconnect account');
                }

            } catch (error) {
                console.error('Auth revocation failed:', error);
                showNotification('error', 'Failed to disconnect Google account');
            }
        }

        // Open MCP server in new tab
        function openMCPServer() {
            window.open('http://localhost:8000', '_blank');
        }

        // Load Google Workspace tools
        async function loadTools() {
            const loadBtn = document.getElementById('load-tools-btn');
            const toolsList = document.getElementById('tools-list');
            const toolsLoading = document.getElementById('tools-loading');
            const noTools = document.getElementById('no-tools');

            if (!authStatus.google_authenticated) {
                toolsList.innerHTML = '';
                noTools.style.display = 'block';
                toolsLoading.style.display = 'none';
                return;
            }

            // Show loading state
            toolsLoading.style.display = 'block';
            noTools.style.display = 'none';
            toolsList.innerHTML = '';

            if (loadBtn) {
                loadBtn.disabled = true;
                const icon = loadBtn.querySelector('i');
                if (icon) icon.classList.add('fa-spin');
            }

            try {
                const response = await fetch('/mcp/tools');
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                toolsLoading.style.display = 'none';

                if (data.external_tools && data.external_tools.length > 0) {
                    updateToolsStatus(data.count);

                    let html = '';
                    data.external_tools.forEach(tool => {
                        html += `
                            <div class="tool-item">
                                <h4>${tool.name}</h4>
                                <p>${tool.description}</p>
                                <div class="tool-badge">Google Workspace</div>
                            </div>
                        `;
                    });
                    toolsList.innerHTML = html;
                } else {
                    updateToolsStatus(0);
                    noTools.style.display = 'block';
                }

            } catch (error) {
                console.error('Failed to load tools:', error);
                toolsLoading.style.display = 'none';
                toolsList.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to load tools: ${error.message}
                    </div>
                `;
                updateToolsStatus(0);
            } finally {
                if (loadBtn) {
                    loadBtn.disabled = false;
                    const icon = loadBtn.querySelector('i');
                    if (icon) icon.classList.remove('fa-spin');
                }
            }
        }

        // Show debug information
        async function showDebugInfo() {
            const debugCard = document.getElementById('debug-card');
            const debugInfo = document.getElementById('debug-info');

            debugCard.style.display = 'block';
            debugInfo.innerHTML = `
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>Loading debug information...</p>
                </div>
            `;

            try {
                const response = await fetch('/debug/mcp-connection');
                const data = await response.json();

                let html = '<div style="font-family: monospace; font-size: 12px;">';
                html += '<h4>MCP Connection Debug Information</h4>';
                html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                html += '</div>';

                debugInfo.innerHTML = html;

            } catch (error) {
                debugInfo.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to load debug information: ${error.message}
                    </div>
                `;
            }
        }

        // Hide debug information
        function hideDebugInfo() {
            document.getElementById('debug-card').style.display = 'none';
        }

        // Show notification
        function showNotification(type, message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'linear-gradient(135deg, #059669 0%, #047857 100%)' :
                           type === 'error' ? 'linear-gradient(135deg, #dc2626 0%, #991b1b 100%)' :
                           'linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%)'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
                z-index: 2000;
                max-width: 350px;
                animation: slideIn 0.3s ease-out;
                font-size: 14px;
            `;

            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // Set up periodic checks
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                checkServerHealth();
                if (authStatus.google_authenticated) {
                    checkAuthStatus();
                }
            }
        }, 30000); // Every 30 seconds

        // Animation styles
        const animationStyle = document.createElement('style');
        animationStyle.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(animationStyle);
    </script>

{% endblock %}