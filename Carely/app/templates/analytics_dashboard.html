{% extends "base.html" %}

{% block content %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <header style="display: flex; justify-content: space-between; align-items: center; padding: 15px 50px; width: 100%; box-sizing: border-box; background-color: #1e293b;">
        <a href="{{ url_for('main.homepage') }}" style="text-decoration: none;">
            <h1 style="margin: 0; color: white; white-space: nowrap;">Carely AI</h1>
        </a>

        <div class="header-nav">
            <a href="{{ url_for('business_agent.category_setup') }}" class="header-btn">üè∑Ô∏è Business Analytics Categories</a>
            <a href="{{ url_for('business_agent.analytics_dashboard') }}" class="header-btn active-header-btn">üìä Analytics Dashboard</a>
            <a href="#" class="header-btn">üöÄ Improve Analytics and Customer Support</a>
        </div>
    </header>

    <div id="left_column">
        <a href="{{ url_for('main.profile') }}" id="profile_link">
            <div id="profile">
                <div id="profile_info">
                    <div id="profile_photo_container">
                        <img src="{{ url_for('main.profile_image') }}" alt="Profile Photo" id="profile_photo">
                    </div>
                    <div id="company_name">{{ session['user'] }}</div>
                </div>
            </div>
        </a>

        <a href="{{ url_for('rag.customer_agent') }}" id="upload_link">Customer Support <br> Agent</a>
        <a href="{{ url_for('business_agent.business_agent') }}" id="dashboard_link">Business Analytics <br> Agent</a>

        <div id="logout_image_container">
            <div id="logout_image_cont">
                <img src="{{ url_for('static', filename='images/logout_img.png') }}" alt="Logout Image" id="logout_image">
            </div>
            <a href="{{ url_for('main.logout') }}" id="logout_link">Logout</a>
        </div>
    </div>

    <div id="content">
        <div id="welcome_msg" style="display: flex; justify-content: space-between; align-items: center; padding-right: 20px;">
            <p id="welcome" style="margin: 0;">WhatsApp Analytics Dashboard</p>

            <div style="display: flex; gap: 10px;">
                <button onclick="fetchDashboardData()" id="refresh-btn" style="background: linear-gradient(135deg, #4682B4 0%, #1e293b 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); transition: transform 0.2s;">
                    <span>üîÑ</span> Refresh Live Data
                </button>
                <button onclick="downloadDashboardPDF()" id="download-btn" style="background: linear-gradient(135deg, #32CD32 0%, #228B22 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); transition: transform 0.2s;">
                    <span>üì•</span> Download PDF
                </button>
            </div>
        </div>

        <div id="pdf-export-area" style="padding: 20px; background-color: #f1f5f9;">

            <div style="background: white; border-radius: 8px; border: 1px solid #cbd5e1; padding: 15px 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">

                <div style="display: flex; align-items: center; gap: 15px;">
                    <a href="{{ url_for('main.profile') }}" style="text-decoration: none;">
                        <div style="width: 55px; height: 55px; border-radius: 50%; overflow: hidden; border: 2px solid #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <img src="{{ url_for('main.profile_image') }}" alt="Profile Photo" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                    </a>
                    <div>
                        <h2 style="margin: 0 0 5px 0; color: #1e293b; font-size: 22px;">Analytics Report: <span style="color: #4682B4;">{{ session['user'] }}</span></h2>
                        <p style="margin: 0; color: #64748b; font-size: 14px;">WhatsApp Customer Support Performance</p>
                    </div>
                </div>

                <div style="text-align: right;">
                    <p style="margin: 0; color: #1e293b; font-weight: bold;">Generated On</p>
                    <p style="margin: 5px 0 0 0; color: #64748b; font-size: 14px;" id="current-date"></p>
                </div>
            </div>

            <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                <div class="content-box kpi-card">
                    <div class="kpi-icon">üì±</div>
                    <div class="kpi-info">
                        <h3 id="kpi-conversations">-</h3>
                        <p>Total WhatsApp Chats</p>
                    </div>
                </div>

                <div class="content-box kpi-card">
                    <div class="kpi-icon">üí¨</div>
                    <div class="kpi-info">
                        <h3 id="kpi-messages">-</h3>
                        <p>Messages Analyzed</p>
                    </div>
                </div>

                <div class="content-box kpi-card">
                    <div class="kpi-icon">üî•</div>
                    <div class="kpi-info">
                        <h3 id="kpi-top-category" style="font-size: 18px;">-</h3>
                        <p>Top Category</p>
                    </div>
                </div>

                <div class="content-box kpi-card">
                    <div class="kpi-icon">üé≠</div>
                    <div class="kpi-info">
                        <h3 id="kpi-sentiment" style="font-size: 18px;">-</h3>
                        <p>Overall Sentiment</p>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: stretch; margin-bottom: 20px;">
                <div class="content-box" style="flex: 1.5; min-width: 400px;">
                    <h3 class="chart-title">üìä Interactions by Category</h3>
                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>

                <div class="content-box" style="flex: 2; min-width: 400px;">
                    <h3 class="chart-title">üìà Message Volume (Last 7 Days)</h3>
                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: stretch;">
                <div class="content-box" style="flex: 1; min-width: 300px;">
                    <h3 class="chart-title">üç© Sentiment Breakdown</h3>
                    <div style="position: relative; height: 300px; width: 100%; display: flex; justify-content: center;">
                        <canvas id="sentimentChart"></canvas>
                    </div>
                </div>

                <div class="content-box" style="flex: 2; min-width: 450px; overflow: hidden; display: flex; flex-direction: column;">
                    <h3 class="chart-title">üí¨ Recent Live Inquiries</h3>
                    <div style="overflow-y: auto; flex: 1;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                    <th style="text-align: left; padding: 12px; color: #475569;">Customer</th>
                                    <th style="text-align: left; padding: 12px; color: #475569;">Message</th>
                                    <th style="text-align: left; padding: 12px; color: #475569;">Category</th>
                                    <th style="text-align: center; padding: 12px; color: #475569;">Sentiment</th>
                                </tr>
                            </thead>
                            <tbody id="recent-messages-tbody">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 20px; color: #94a3b8;">Loading recent messages...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        html, body { height: 100%; margin: 0; padding: 0; }

        #content { min-height: 100vh; padding-bottom: 50px; box-sizing: border-box; background-color: #f1f5f9; }

        /* Header Nav Styles */
        .header-nav { display: flex; flex: 1; justify-content: flex-start; padding-left: 60px; gap: 40px; align-items: center; }
        .header-btn { padding: 10px 20px; border-radius: 8px; text-decoration: none; font-size: 15px; font-weight: 600; color: #cbd5e1; background-color: transparent; transition: all 0.3s ease; text-align: center; }
        .active-header-btn { background-color: #ffffff !important; color: #1e293b !important; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); transform: translateY(-2px); }
        .header-btn:hover { background-color: #ffffff !important; color: #1e293b !important; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); transform: translateY(-2px); }
        .header-nav:hover .active-header-btn:not(:hover) { background-color: transparent !important; color: #cbd5e1 !important; box-shadow: none !important; transform: none !important; }

        /* KPI Card Styles */
        .kpi-card { flex: 1; min-width: 200px; display: flex; align-items: center; gap: 20px; padding: 25px !important; }

        /* UPDATED: Sleek, Dark Background for KPI Emojis */
        .kpi-icon {
            font-size: 30px;
            background-color: #1e293b; /* Dark Navy/Slate matches your header */
            color: white;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid #cbd5e1;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .kpi-info h3 { margin: 0; font-size: 24px; color: #1e293b; }
        .kpi-info p { margin: 5px 0 0 0; color: #64748b; font-size: 13px; font-weight: bold; text-transform: uppercase; }

        .chart-title { color: #1e293b; margin-top: 0; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; font-size: 16px;}

        /* Table Badges */
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; white-space: nowrap; }
        .badge-cat { background: #e2e8f0; color: #334155; border: 1px solid #94a3b8; }
        .badge-pos { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .badge-neu { background: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; }
        .badge-neg { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        #refresh-btn:active, #download-btn:active { transform: scale(0.95); }

        @media (max-width: 1024px) {
            .header-nav { gap: 20px; padding-left: 30px; }
            .header-btn { font-size: 13px; padding: 8px 12px; }
        }
        @media (max-width: 768px) {
            .header-nav { display: none; }
            #welcome_msg { flex-direction: column; align-items: flex-start; gap: 15px; }
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date in header for the PDF
            const dateOpts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-US', dateOpts);

            fetchDashboardData();
        });

        // Store charts globally to replace them on refresh
        let windowLineChartInst = null;
        let windowSentimentChartInst = null;
        let windowBarChartInst = null;

        // --- PDF Generation Logic ---
        function downloadDashboardPDF() {
            const btn = document.getElementById('download-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = "<span>‚è≥</span> Exporting...";
            btn.disabled = true;

            // Target the wrapper div that contains the report header, KPIs, and Charts
            const element = document.getElementById('pdf-export-area');

            const opt = {
                margin:       0.2,
                filename:     `{{ session['user'] }}_Carely_Analytics.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, windowWidth: 1200 },
                jsPDF:        { unit: 'in', format: 'a3', orientation: 'landscape' }
            };

            // Process and re-enable UI
            html2pdf().set(opt).from(element).save().then(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        // --- Data Fetching Logic ---
        function fetchDashboardData() {
            const btn = document.getElementById('refresh-btn');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = "<span>‚è≥</span> Loading...";
            btn.disabled = true;

            fetch("{{ url_for('business_agent.dashboard_stats') }}")
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // 1. Update KPIs
                        document.getElementById('kpi-conversations').innerText = data.kpis.total_conversations;
                        document.getElementById('kpi-messages').innerText = data.kpis.total_messages_analyzed;
                        document.getElementById('kpi-top-category').innerText = data.kpis.top_category;
                        document.getElementById('kpi-sentiment').innerText = data.kpis.overall_sentiment;

                        // 2. Render Charts
                        renderCharts(data.charts);

                        // 3. Render Latest Messages
                        renderTable(data.recent_messages);
                    } else {
                        console.error("Error:", data.error);
                        document.getElementById('recent-messages-tbody').innerHTML = `<tr><td colspan="4" style="text-align: center; color: red;">Failed to load data.</td></tr>`;
                    }
                })
                .catch(error => console.error("Error:", error))
                .finally(() => {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                });
        }

        function renderCharts(chartsData) {
            // Destroy existing instances to prevent ghosting
            if(windowLineChartInst) windowLineChartInst.destroy();
            if(windowSentimentChartInst) windowSentimentChartInst.destroy();
            if(windowBarChartInst) windowBarChartInst.destroy();

            Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
            Chart.defaults.color = '#64748b';

            // 1. Bar Chart (Categories)
            let barLabels = [];
            let barData = [];
            for(let i=0; i < chartsData.categories.labels.length; i++){
                if(chartsData.categories.data[i] > 0){
                    barLabels.push(chartsData.categories.labels[i]);
                    barData.push(chartsData.categories.data[i]);
                }
            }
            if(barLabels.length === 0) { barLabels = ["No Data Yet"]; barData = [1]; }

            const ctxBar = document.getElementById('barChart').getContext('2d');
            windowBarChartInst = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: barLabels,
                    datasets: [{
                        label: 'Messages',
                        data: barData,
                        backgroundColor: 'rgba(70, 130, 180, 0.8)',
                        borderColor: 'rgba(70, 130, 180, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } }, x: { grid: {display: false} } }
                }
            });

            // 2. Line Chart (Volume)
            const ctxLine = document.getElementById('lineChart').getContext('2d');
            windowLineChartInst = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: chartsData.volume.labels,
                    datasets: [{
                        label: 'Messages',
                        data: chartsData.volume.data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#3b82f6',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { precision: 0 } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // 3. Doughnut Chart (Sentiment)
            const ctxDoughnut = document.getElementById('sentimentChart').getContext('2d');
            windowSentimentChartInst = new Chart(ctxDoughnut, {
                type: 'doughnut',
                data: {
                    labels: chartsData.sentiment.labels,
                    datasets: [{
                        data: chartsData.sentiment.data,
                        backgroundColor: ['#22c55e', '#cbd5e1', '#ef4444'], // Pos, Neu, Neg
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    cutout: '65%'
                }
            });
        }

        function renderTable(messages) {
            const tbody = document.getElementById('recent-messages-tbody');

            if (!messages || messages.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 20px; color: #94a3b8;">No customer messages recorded yet.</td></tr>`;
                return;
            }

            let html = '';
            messages.forEach(msg => {
                let sentBadge = '<span class="badge badge-neu">Neutral</span>';
                if (msg.sentiment > 0.25) sentBadge = '<span class="badge badge-pos">Positive üòÉ</span>';
                else if (msg.sentiment < -0.25) sentBadge = '<span class="badge badge-neg">Negative üò†</span>';

                let displayContent = msg.content;
                if (displayContent.length > 50) {
                    displayContent = displayContent.substring(0, 50) + "...";
                }

                html += `
                    <tr style="border-bottom: 1px solid #f1f5f9;">
                        <td style="padding: 12px; color: #1e293b;">
                            <strong>${msg.customer_name}</strong><br>
                            <span style="font-size: 11px; color: #94a3b8;">${msg.phone} ‚Ä¢ ${msg.time}</span>
                        </td>
                        <td style="padding: 12px; color: #475569;">"${displayContent}"</td>
                        <td style="padding: 12px;"><span class="badge badge-cat">${msg.category}</span></td>
                        <td style="padding: 12px; text-align: center;">${sentBadge}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }
    </script>
{% endblock %}